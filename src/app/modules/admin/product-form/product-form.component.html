<div class="position-relative">
  <h3 mat-dialog-title>
    {{ product ? "Editar " + product.model : "Crear producto" }}
  </h3>
  <div mat-dialog-content>
    <form
      [formGroup]="productForm"
      (ngSubmit)="submit($event)"
      class="d-flex flex-column mt-3"
    >
      <div class="mb-4">
        <button
          type="button"
          color="accent"
          mat-flat-button
          (click)="fileInput.click()"
        >
          Choose File
        </button>
        <input
          hidden
          (change)="onFileSelected($event)"
          #fileInput
          type="file"
        />
        <span *ngFor="let file of selectedFiles" class="file-name"
          >{{ file.name }},&nbsp;
        </span>
      </div>

      <div class="mb-4 col-12 d-flex justify-content-center align-items-center">
        <ng-container *ngIf="product">
          <div class="col-3 product_image" *ngFor="let item of product.images">
            <ng-container>
              <img
                class="col-12"
                [src]="item.image"
                [ngClass]="{
                  'image-deleted': isImageInImagesToDeleteList(item)
                }"
                alt="image"
              />
              <div class="overlay">
                <mat-icon
                  color="accent"
                  class="w-100 h-100 text-center fs-1"
                  *ngIf="isImageInImagesToDeleteList(item)"
                >
                  delete
                </mat-icon>
                <button
                  mat-flat-button
                  color="accent"
                  (click)="handleDeleteImage($event, item)"
                >
                  {{
                    isImageInImagesToDeleteList(item) ? "Cancelar" : "Eliminar"
                  }}
                </button>
              </div>
            </ng-container>
          </div>
        </ng-container>
      </div>
      <mat-form-field>
        <mat-label>Marca</mat-label>
        <mat-select formControlName="brand">
          <mat-option *ngFor="let brand of brands" [value]="brand">
            {{ brand }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="model.hasError('required')">
          Debe ingresar el modelo del producto.</mat-error
        >
      </mat-form-field>

      <mat-form-field>
        <mat-label>Modelo</mat-label>
        <input matInput type="text" formControlName="model" />
        <mat-error *ngIf="model.hasError('required')">
          Debe ingresar el modelo del producto.</mat-error
        >
      </mat-form-field>

      <mat-form-field>
        <mat-label>Precio</mat-label>
        <input matInput type="number" formControlName="price" />
        <mat-error *ngIf="price.hasError('required')">
          Debe ingresar un precio para el producto.</mat-error
        >
        <mat-error *ngIf="price.hasError('nonNegative')"
          >El precio no puede ser negativo.</mat-error
        >
      </mat-form-field>

      <mat-form-field>
        <mat-label>Cantidad</mat-label>
        <input matInput type="number" formControlName="quantity" />
        <mat-error *ngIf="quantity.hasError('required')">
          Debe ingresar una cantidad para el producto.</mat-error
        >
        <mat-error *ngIf="quantity.hasError('nonNegative')"
          >La cantidad no puede ser negativa.</mat-error
        >
      </mat-form-field>

      <mat-form-field>
        <mat-label>Categoría</mat-label>
        <mat-select formControlName="category">
          <mat-option
            *ngFor="let category of productCategories"
            [value]="category.value"
          >
            {{ category.text }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="category.hasError('required')">
          Debe seleccionar una categoría para el producto.</mat-error
        >
      </mat-form-field>

      <mat-form-field>
        <mat-label>Descripción</mat-label>
        <input matInput type="text" formControlName="description" />
        <mat-error *ngIf="description.hasError('required')">
          Debe ingresar una descripción para el producto.</mat-error
        >
        <mat-error *ngIf="description.hasError('minlength')">
          La descripción debe tener al menos 15 caracteres.</mat-error
        >
      </mat-form-field>

      <div mat-dialog-actions class="d-flex justify-content-end gap-2">
        <button mat-button (click)="closeProductForm()" type="button">
          Cancelar
        </button>
        <button mat-flat-button type="submit" color="accent">Aceptar</button>
      </div>
    </form>
  </div>
  <div class="loading-spinner-container" *ngIf="loading">
    <app-loading-spinner class="loading-spinner"></app-loading-spinner>
  </div>
</div>
